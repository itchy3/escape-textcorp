<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESCAPE FROM TEXTCORP</title>
  <style>
    :root {
      --hp-color: #e63946;
      --hunger-color: #ffb703;
      --stat-color: #00b4d8;
      --escape-color: #9d4edd;
      --bg: #0a0a0a;
      --panel: #121212;
      --text: #d8dee9;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: "Noto Sans KR", sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start;
      min-height: 100vh;
    }
    header {
      font-size: 1.5rem; font-weight: 600; margin: 24px 0; color: #e0e0e0;
      letter-spacing: 1px; text-shadow: 0 0 10px #3b82f6;
    }
    #game-container {
      background: var(--panel); width: 95%; max-width: 700px;
      padding: 20px; border-radius: 16px; box-shadow: 0 0 16px rgba(0,0,0,0.7);
    }
    #stats { margin-bottom: 20px; }
    .bar { position: relative; background: #333; height: 18px; border-radius: 10px; overflow: hidden; margin: 6px 0; }
    .bar-fill { height: 100%; transition: width 0.4s ease; }
    .label { font-size: 0.85rem; margin-bottom: 2px; opacity: 0.9; }
    #log {
      max-height: 50vh; overflow-y: auto; background: #0e0e0e; padding: 15px; border-radius: 10px;
      font-size: 0.95rem; line-height: 1.5em; white-space: pre-wrap; box-shadow: inset 0 0 6px rgba(0,0,0,0.5);
    }
    #input-area { display: flex; justify-content: space-between; margin-top: 16px; }
    #item-input {
      flex: 1; padding: 8px; border: none; border-radius: 8px; background: #1e1e1e; color: white; font-size: 1rem; outline: none;
    }
    #send-btn {
      background: #3b82f6; color: white; border: none; border-radius: 8px; margin-left: 8px; padding: 8px 14px; cursor: pointer; transition: 0.3s;
    }
    #send-btn:hover { background: #60a5fa; }
    #choices { margin-top: 18px; }
    .choice-btn {
      display: block; width: 100%; padding: 10px; margin: 8px 0;
      background: #2a2a2a; color: #eee; border: 1px solid #333; border-radius: 8px;
      font-size: 0.95rem; cursor: pointer; text-align: left; transition: background 0.2s, transform 0.1s;
    }
    .choice-btn:hover { background: #3b3b3b; transform: scale(1.01); }
    @media (max-width: 600px) {
      #game-container { padding: 12px; }
      #item-input, #send-btn { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <header>ESCAPE FROM TEXTCORP</header>
  <div id="game-container">
    <div id="stats">
      <div class="label">ì²´ë ¥</div>
      <div class="bar"><div id="hp-bar" class="bar-fill" style="background: var(--hp-color); width: 100%;"></div></div>
      <div class="label">í—ˆê¸°</div>
      <div class="bar"><div id="hunger-bar" class="bar-fill" style="background: var(--hunger-color); width: 100%;"></div></div>
      <div class="label" id="custom-label">ë§ì¶¤ìŠ¤íƒ¯</div>
      <div class="bar"><div id="custom-bar" class="bar-fill" style="background: var(--stat-color); width: 100%;"></div></div>
      <div class="label">íƒˆì¶œìƒí™©</div>
      <div class="bar"><div id="escape-bar" class="bar-fill" style="background: var(--escape-color); width: 0%;"></div></div>
    </div>

    <div id="log">ğŸ® ê°ì˜¥ì„¬ì˜ ìƒˆë²½ ê³µê¸°ê°€ ì‹¸ëŠ˜í•˜ë‹¤.<br>ë¬¼ê±´ì„ ì…ë ¥í•˜ì„¸ìš” (10ì ì´ë‚´).</div>

    <div id="input-area">
      <input id="item-input" type="text" maxlength="10" placeholder="ì˜ˆ: ê¶Œì´, ë§ˆë²•ì§€íŒ¡ì´..." />
      <button id="send-btn">ì‹œì‘</button>
    </div>

    <div id="choices"></div>
  </div>

  <script>
    const log = document.getElementById("log");
    const inputArea = document.getElementById("input-area");
    const itemInput = document.getElementById("item-input");
    const sendBtn = document.getElementById("send-btn");
    const choices = document.getElementById("choices");

    const hpBar = document.getElementById("hp-bar");
    const hungerBar = document.getElementById("hunger-bar");
    const customBar = document.getElementById("custom-bar");
    const escapeBar = document.getElementById("escape-bar");

    // âœ… ìƒíƒœ ì €ì¥ (0~100 í´ë¨í”„, ë§ì¶¤ìŠ¤íƒ¯ ë™ì ëª…/ë‹¨ìœ„)
    const state = {
      hp: 100,
      hunger: 100,
      escape: 0,
      custom: { name: "ë§ì¶¤ìŠ¤íƒ¯", curr: 100, max: 100, unit: "" }
    };

    let history = [];
    let hiddenPrompt = "";

    const appendLog = (text, sender = "ai") => {
      const prefix = sender === "user" ? "ğŸ§â€â™‚ï¸ ë‹¹ì‹ : " : "ğŸ¤– AI: ";
      log.innerHTML += `\n${prefix}${text}`;
      log.scrollTop = log.scrollHeight;
    };

    const sendMessage = async (msg) => {
      const response = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body:
