<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESCAPE FROM TEXTCORP</title>
  <style>
    :root {
      --hp-color: #e63946;
      --hunger-color: #ffb703;
      --stat-color: #00b4d8;
      --escape-color: #9d4edd;
      --bg: #0a0a0a;
      --panel: #121212;
      --text: #d8dee9;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: "Noto Sans KR", sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start;
      min-height: 100vh;
    }
    header {
      font-size: 1.5rem; font-weight: 600; margin: 24px 0; color: #e0e0e0;
      letter-spacing: 1px; text-shadow: 0 0 10px #3b82f6;
    }
    #game-container {
      background: var(--panel); width: 95%; max-width: 700px;
      padding: 20px; border-radius: 16px; box-shadow: 0 0 16px rgba(0,0,0,0.7);
    }
    /* ì²˜ìŒì—ëŠ” ìƒíƒœì°½ ìˆ¨ê¹€ */
    #stats { margin-bottom: 20px; display: none; }
    .stat-row { margin-bottom: 10px; }
    .label-line {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.85rem; margin-bottom: 2px; opacity: 0.9;
    }
    .bar { position: relative; background: #333; height: 18px; border-radius: 10px; overflow: hidden; }
    .bar-fill { height: 100%; transition: width 0.4s ease; }
    /* 0%ì¼ ë•Œë„ ë°”ì˜ ìœ¤ê³½ì´ ë³´ì´ë„ë¡ ì–‡ì€ ì¸ë””ì¼€ì´í„°(ë°°ê²½ìœ¼ë¡œ ì¶©ë¶„í•˜ì§€ë§Œ í…ìŠ¤íŠ¸ê°€ ìˆì–´ ëª…í™•) */
    .bar-text {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.8rem; color: #ddd; pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    #log {
      max-height: 50vh; overflow-y: auto; background: #0e0e0e; padding: 15px; border-radius: 10px;
      font-size: 0.95rem; line-height: 1.5em; white-space: pre-wrap; box-shadow: inset 0 0 6px rgba(0,0,0,0.5);
    }
    #input-area { display: flex; justify-content: space-between; margin-top: 16px; }
    #item-input {
      flex: 1; padding: 8px; border: none; border-radius: 8px; background: #1e1e1e; color: white; font-size: 1rem; outline: none;
    }
    #send-btn {
      background: #3b82f6; color: white; border: none; border-radius: 8px; margin-left: 8px; padding: 8px 14px; cursor: pointer; transition: 0.3s;
    }
    #send-btn:hover { background: #60a5fa; }
    #choices { margin-top: 18px; }
    .choice-btn {
      display: block; width: 100%; padding: 10px; margin: 8px 0;
      background: #2a2a2a; color: #eee; border: 1px solid #333; border-radius: 8px;
      font-size: 0.95rem; cursor: pointer; text-align: left; transition: background 0.2s, transform 0.1s;
    }
    .choice-btn:hover { background: #3b3b3b; transform: scale(1.01); }
    @media (max-width: 600px) {
      #game-container { padding: 12px; }
      #item-input, #send-btn { font-size: 0.9rem; }
    }
  </style>
</head>
<body>
  <header>ESCAPE FROM TEXTCORP</header>
  <div id="game-container">
    <div id="stats">
      <div class="stat-row">
        <div class="label-line">
          <div class="label">ì²´ë ¥</div><div id="hp-text">â€”/100</div>
        </div>
        <div class="bar">
          <div id="hp-bar" class="bar-fill" style="background: var(--hp-color); width: 0%;"></div>
          <div class="bar-text"></div>
        </div>
      </div>

      <div class="stat-row">
        <div class="label-line">
          <div class="label">í—ˆê¸°</div><div id="hunger-text">â€”/100</div>
        </div>
        <div class="bar">
          <div id="hunger-bar" class="bar-fill" style="background: var(--hunger-color); width: 0%;"></div>
          <div class="bar-text"></div>
        </div>
      </div>

      <div class="stat-row">
        <div class="label-line">
          <div id="custom-label" class="label">ë§ì¶¤ìŠ¤íƒ¯</div><div id="custom-text">â€”/â€”</div>
        </div>
        <div class="bar">
          <div id="custom-bar" class="bar-fill" style="background: var(--stat-color); width: 0%;"></div>
          <div class="bar-text"></div>
        </div>
      </div>

      <div class="stat-row">
        <div class="label-line">
          <div class="label">íƒˆì¶œìƒí™©</div><div id="escape-text">0%</div>
        </div>
        <div class="bar">
          <div id="escape-bar" class="bar-fill" style="background: var(--escape-color); width: 0%;"></div>
          <div class="bar-text"></div>
        </div>
      </div>
    </div>

    <div id="log">ğŸ® ê°ì˜¥ì„¬ì˜ ìƒˆë²½ ê³µê¸°ê°€ ì‹¸ëŠ˜í•˜ë‹¤.<br>ë¬¼ê±´ì„ ì…ë ¥í•˜ì„¸ìš” (10ì ì´ë‚´).</div>

    <div id="input-area">
      <input id="item-input" type="text" maxlength="10" placeholder="ì˜ˆ: ê¶Œì´, ë§ˆë²•ì§€íŒ¡ì´..." />
      <button id="send-btn">ì‹œì‘</button>
    </div>

    <div id="choices"></div>
  </div>

  <script>
    const log = document.getElementById("log");
    const inputArea = document.getElementById("input-area");
    const itemInput = document.getElementById("item-input");
    const sendBtn = document.getElementById("send-btn");
    const choices = document.getElementById("choices");
    const statsEl = document.getElementById("stats");

    const hpBar = document.getElementById("hp-bar");
    const hungerBar = document.getElementById("hunger-bar");
    const customBar = document.getElementById("custom-bar");
    const escapeBar = document.getElementById("escape-bar");

    const hpText = document.getElementById("hp-text");
    const hungerText = document.getElementById("hunger-text");
    const customText = document.getElementById("custom-text");
    const escapeText = document.getElementById("escape-text");
    const customLabel = document.getElementById("custom-label");

    let history = [];
    let hiddenPrompt = "";

    const appendLog = (text, sender = "ai") => {
      const prefix = sender === "user" ? "ğŸ§â€â™‚ï¸ ë‹¹ì‹ : " : "ğŸ¤– AI: ";
      log.innerHTML += `\n${prefix}${text}`;
      log.scrollTop = log.scrollHeight;
    };

    const sendMessage = async (msg) => {
      const response = await fetch("/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: msg, history }),
      });
      const data = await response.json();
      const reply = data.reply || "(ì‘ë‹µ ì—†ìŒ)";
      history.push({ role: "user", content: msg });
      history.push({ role: "assistant", content: reply });
      appendLog(reply, "ai");
      handleAIResponse(reply);
    };

    // ì„ íƒì§€ ì¶”ì¶œ
    const extractChoices = (text) => {
      const lines = text.split(/\r?\n/);
      const results = [];
      for (const raw of lines) {
        const line = raw.trim();
        let m = line.match(/^(1ï¸âƒ£|2ï¸âƒ£|3ï¸âƒ£)\s*(.+)?$/);
        if (m) { results.push({ id: m[1], label: m[2]?.trim() || m[1] }); continue; }
        m = line.match(/^([1-3])\.\s*(.+)$/);
        if (m) { results.push({ id: m[1] + "ï¸âƒ£", label: m[2].trim() }); continue; }
        m = line.match(/^([1-3])\)\s*(.+)$/);
        if (m) { results.push({ id: m[1] + "ï¸âƒ£", label: m[2].trim() }); continue; }
        m = line.match(/^([â‘ â‘¡â‘¢])\s*(.+)$/);
        if (m) {
          const map = { "â‘ ": "1ï¸âƒ£", "â‘¡": "2ï¸âƒ£", "â‘¢": "3ï¸âƒ£" };
          results.push({ id: map[m[1]], label: m[2].trim() });
          continue;
        }
      }
      return results;
    };

    // AI ì‘ë‹µ ì²˜ë¦¬
    const handleAIResponse = (text) => {
      hiddenPrompt = text;
      choices.innerHTML = "";
      updateStatsFromText(text);

      const opts = extractChoices(text);
      if (opts.length) {
        opts.forEach(({ id, label }) => {
          const btn = document.createElement("button");
          btn.className = "choice-btn";
          btn.textContent = `${id} ${label}`;
          btn.onclick = () => {
            appendLog(`${id} ${label}`, "user");
            sendMessage(`ì„ íƒ: ${id}`);
          };
          choices.appendChild(btn);
        });
      }
    };

    // ìˆ˜ì¹˜ ì—…ë°ì´íŠ¸ (0ë„ ì •í™•íˆ í‘œì‹œ)
    const updateBar = (barEl, textEl, value, max = 100, isPercent = false) => {
      const v = Math.max(0, Math.min(max, Number.isFinite(value) ? value : 0));
      const pct = isPercent ? v : (v / max) * 100;
      barEl.style.width = `${pct}%`;
      textEl.textContent = isPercent ? `${v}%` : `${v}/${max}`;
      // ë°” ì¤‘ì•™ í…ìŠ¤íŠ¸ë„ ë™ì¼ í‘œì‹œ
      const overlay = barEl.parentElement.querySelector(".bar-text");
      if (overlay) overlay.textContent = isPercent ? `${v}%` : `${v}/${max}`;
    };

    // í…ìŠ¤íŠ¸ì—ì„œ ìˆ˜ì¹˜ ì¶”ì¶œ â†’ ê²Œì´ì§€ & ìˆ«ì ë™ê¸°í™”
    const updateStatsFromText = (text) => {
      // ë§ì¶¤ìŠ¤íƒ¯ ë¼ë²¨ ì´ë¦„ê¹Œì§€ ë™ì  ì¶”ì¶œ (ì˜ˆ: "ì´ì•Œ: 16/16" â†’ ë¼ë²¨ "ì´ì•Œ")
      // ìš°ì„  "ë§ì¶¤ìŠ¤íƒ¯: ..." íŒ¨í„´ ìš°ì„ , ì—†ìœ¼ë©´ "[í•œê¸€/ì˜ë¬¸/ìˆ«ì]+: A/B" í¬ë§·ì„ íƒìƒ‰
      const hp = text.match(/ì²´ë ¥[:ï¼š]?\s*(\d+)/);
      const hunger = text.match(/í—ˆê¸°[:ï¼š]?\s*(\d+)/);
      const custom = text.match(/ë§ì¶¤\s*ìŠ¤íƒ¯|ë§ì¶¤ìŠ¤íƒ¯|ì»¤ìŠ¤í…€\s*ìŠ¤íƒ¯/i)
        ? text.match(/ë§ì¶¤\s*ìŠ¤íƒ¯[:ï¼š]?\s*([^\n]+)/i)
        : null;
      const genericCustom = custom ? null : text.match(/^\s*([ê°€-í£A-Za-z0-9_]+)\s*[:ï¼š]\s*(\d+)\s*\/\s*(\d+)/m);
      const escapeVal = text.match(/íƒˆì¶œ\s*ìƒí™©[:ï¼š]?\s*(\d+)/);

      if (hp) updateBar(hpBar, hpText, parseInt(hp[1], 10), 100, false);
      if (hunger) updateBar(hungerBar, hungerText, parseInt(hunger[1], 10), 100, false);

      if (custom) {
        const val = custom[1].match(/(\d+)\s*\/\s*(\d+)/);
        if (val) {
          customLabel.textContent = "ë§ì¶¤ìŠ¤íƒ¯";
          updateBar(customBar, customText, parseInt(val[1], 10), parseInt(val[2], 10), false);
        }
      } else if (genericCustom) {
        const labelName = genericCustom[1];
        const cur = parseInt(genericCustom[2], 10);
        const max = parseInt(genericCustom[3], 10);
        customLabel.textContent = labelName; // ë™ì ìœ¼ë¡œ ë¼ë²¨ ë³€ê²½
        updateBar(customBar, customText, cur, max, false);
      }

      if (escapeVal) updateBar(escapeBar, escapeText, parseInt(escapeVal[1], 10), 100, true);
    };

    // ì‹œì‘
    sendBtn.onclick = () => {
      const item = itemInput.value.trim();
      if (!item) return alert("ì•„ì´í…œì„ ì…ë ¥í•˜ì„¸ìš”!");
      if (item.length > 10) return alert("10ì ì´ë‚´ë¡œ ì…ë ¥í•˜ì„¸ìš”.");
      appendLog(item, "user");
      sendMessage(`ì•„ì´í…œìœ¼ë¡œ '${item}'ì„ ì„ íƒí•©ë‹ˆë‹¤.`);

      // ì•„ì´í…œ ë“±ë¡ ì§í›„ ìƒíƒœì°½ í‘œì‹œ
      statsEl.style.display = "block";
      // ì…ë ¥ ì˜ì—­ ë¹„í™œì„±í™”
      inputArea.style.display = "none";
    };
  </script>
</body>
</html>
