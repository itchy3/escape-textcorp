// 공용: 0~100 클램프
const clamp01 = (v) => Math.max(0, Math.min(100, v));

// 숫자 추출 유틸 (문자 안의 숫자만)
const toInt = (s) => parseInt(String(s).replace(/[^\d-]/g, ""), 10);

// ✅ 텍스트에서 수치 파싱 → state 갱신
function updateStatsFromText(text) {
  // ----- 체력/허기/탈출상황: 절대값(체력: 75), 상대값(허기 -20) 모두 지원 -----
  // 체력
  let m;
  if ((m = text.match(/체력\s*[:：]?\s*(-?\d{1,3})\b/))) {
    state.hp = clamp01(toInt(m[1]));
  }
  if ((m = text.match(/체력\s*([+-])\s*(\d{1,3})\b/))) {
    const delta = (m[1] === "+" ? 1 : -1) * toInt(m[2]);
    state.hp = clamp01(state.hp + delta);
  }

  // 허기
  if ((m = text.match(/허기\s*[:：]?\s*(-?\d{1,3})\b/))) {
    state.hunger = clamp01(toInt(m[1]));
  }
  if ((m = text.match(/허기\s*([+-])\s*(\d{1,3})\b/))) {
    const delta = (m[1] === "+" ? 1 : -1) * toInt(m[2]);
    state.hunger = clamp01(state.hunger + delta);
  }

  // 탈출상황 / 탈출 상황
  if ((m = text.match(/탈출\s*상황\s*[:：]?\s*(-?\d{1,3})\b|탈출상황\s*[:：]?\s*(-?\d{1,3})\b/))) {
    const v = toInt(m[1] ?? m[2]);
    state.escape = clamp01(v);
  }
  if ((m = text.match(/탈출\s*상황\s*([+-])\s*(\d{1,3})\b|탈출상황\s*([+-])\s*(\d{1,3})\b/))) {
    const sign = (m[1] ?? m[3]);
    const val  = toInt(m[2] ?? m[4]);
    const delta = (sign === "+" ? 1 : -1) * val;
    state.escape = clamp01(state.escape + delta);
  }

  // ----- 맞춤스탯: 이름/단위 포함 (예: "총알 16/16", "액체 200ml/200ml") -----
  // 패턴 1: "맞춤스탯: 총알 16/16" 또는 "맞춤스탯: 액체 200ml/200ml"
  let c = text.match(/맞춤\s*스탯\s*[:：]?\s*([^\s:：]+)\s+(\d+)\s*([a-zA-Z%가-힣]*)\s*\/\s*(\d+)\s*(?:[a-zA-Z%가-힣]*)/);
  // 패턴 2: "총알: 16/16" "액체: 200ml/200ml" "Bullets 30/60"
  if (!c) c = text.match(/([^\s:：]+)\s*[:：]?\s*(\d+)\s*([a-zA-Z%가-힣]*)\s*\/\s*(\d+)\s*(?:[a-zA-Z%가-힣]*)/);

  if (c) {
    const statName = c[1].trim();
    const curr = toInt(c[2]);
    const unit = (c[3] || "").trim(); // "ml" 같은 단위(없어도 됨)
    const max  = toInt(c[4]);

    // 이름이 체력/허기/탈출상황 등 기본 스탯 단어면 스킵 (오탐 방지)
    const reserved = ["체력","허기","탈출","탈출상황","탈출","상황"];
    const looksReserved = reserved.some(k => statName.includes(k));
    if (!looksReserved && max > 0) {
      state.custom.name = statName;     // 라벨 이름 교체
      state.custom.curr = Math.max(0, curr);
      state.custom.max  = Math.max(1, max); // 0 분모 방지
      state.custom.unit = unit;         // 필요 시 표시할 수 있도록 저장
    }
  }

  // 실제 게이지 반영
  applyStateToBars();
}

// ✅ state → 게이지 DOM 반영
function applyStateToBars() {
  // 0도 정확히 표시 (폭=0%)
  hpBar.style.width     = `${clamp01(state.hp)}%`;
  hungerBar.style.width = `${clamp01(state.hunger)}%`;
  escapeBar.style.width = `${clamp01(state.escape)}%`;

  // 맞춤스탯 퍼센트
  const customPct = clamp01((state.custom.curr / state.custom.max) * 100 || 0);
  customBar.style.width = `${customPct}%`;

  // 맞춤스탯 라벨 이름 동적 반영
  const customLabel = document.getElementById("custom-label");
  if (customLabel) {
    customLabel.textContent = state.custom.name;
  }
}
